name: Send Birthday Emails
on:
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * *'  # Runs daily at 18:30 UTC
jobs:
  send-birthday-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
          
      - name: Install dependencies
        run: npm install axios
        
      - name: Check Birthday List and Send Emails
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          echo "Checking today's birthdays..."
          birthdays=$(cat birthdays.json)
          today=$(date +%m-%d)
          
          # Extract all birthdays for today and store as JSON array
          todays_birthdays=$(echo "$birthdays" | jq --arg today "$today" '[.[] | select(.birthday == $today)]')
          birthday_count=$(echo "$todays_birthdays" | jq length)
          
          if [ "$birthday_count" -eq 0 ]; then
            echo "No birthdays today."
            exit 0
          fi
          
          echo "Found $birthday_count birthdays today!"
          
          # Loop through each birthday person
          for i in $(seq 0 $(($birthday_count - 1))); do
            name=$(echo "$todays_birthdays" | jq -r ".[$i].name")
            email=$(echo "$todays_birthdays" | jq -r ".[$i].email")
            
            echo "Generating birthday message for $name..."
            
            # Generate birthday message
            message=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent" \
              -H "Content-Type: application/json" \
              -H "x-goog-api-key: $GEMINI_API_KEY" \
              -d '{
                "contents": [{
                  "parts": [{
                    "text": "Write a warm, personalized birthday message for '"$name"'. Keep it under 100 words. Include some emojis."
                  }]
                }]
              }' | jq -r '.candidates[0].content.parts[0].text')
              
            if [ -z "$message" ] || [ "$message" == "null" ]; then
              message="Happy Birthday, $name! ðŸŽ‰ Wishing you a fantastic day filled with love and joy! ðŸŽ‚"
            fi
            
            # Send email
            echo "Sending birthday email to $name at $email..."
            
            # Create a temporary email content file
            email_content=$(cat <<EOF
Subject: Happy Birthday, $name! ðŸŽ‰
From: Girish Raghav <$EMAIL_USERNAME>
To: $email
Content-Type: text/plain; charset="UTF-8"

$message

Best wishes,
Girish Raghav
EOF
)
            
            # Use curl to send the email via SMTP
            echo "$email_content" | curl --url "smtp://$SMTP_SERVER:$SMTP_PORT" \
              --ssl-reqd \
              --mail-from "$EMAIL_USERNAME" \
              --mail-rcpt "$email" \
              --user "$EMAIL_USERNAME:$EMAIL_PASSWORD" \
              -T -
              
            echo "Email sent to $name!"
          done
